-- Place this in ServerScriptService
local Players = game:GetService("Players")
local TOOL_NAME = "Pistol"

-- Deletes all tools named Pistol except keepTool
local function deleteAllButOne(player, keepTool)
	local containers = {player.Backpack, player.Character}
	for _, container in ipairs(containers) do
		if container then
			for _, t in ipairs(container:GetChildren()) do
				if t:IsA("Tool") and t.Name == TOOL_NAME and t ~= keepTool then
					t:Destroy()
				end
			end
		end
	end
end

-- Handles cloning, equipping, and deleting old tool
local function cloneAndEquip(player, oldTool)
	if not oldTool or not oldTool.Parent then return end
	local humanoid = player.Character and player.Character:FindFirstChild("Humanoid")
	if not humanoid then return end

	-- Step 1: Delete all other Pistols
	deleteAllButOne(player, oldTool)

	-- Step 2: Clone the tool
	local newTool = oldTool:Clone()
	newTool.Name = TOOL_NAME
	newTool.Parent = player.Backpack

	-- Step 3: Equip the clone
	humanoid:EquipTool(newTool)

	-- Step 4: Delete the original
	task.delay(0.05, function()
		if oldTool.Parent then oldTool:Destroy() end
	end)
end

-- Connect tool activation
local function handleTool(tool)
	if not tool:IsA("Tool") then return end
	local player = Players:GetPlayerFromCharacter(tool.Parent)
	if not player then return end

	tool.Activated:Connect(function()
		cloneAndEquip(player, tool)
	end)
end

-- Monitor container for tools
local function monitorContainer(container)
	for _, t in ipairs(container:GetChildren()) do
		if t:IsA("Tool") and t.Name == TOOL_NAME then handleTool(t) end
	end
	container.ChildAdded:Connect(function(child)
		if child:IsA("Tool") and child.Name == TOOL_NAME then handleTool(child) end
	end)
end

-- Monitor player's backpack and character
local function monitorPlayer(player)
	if player.Character then monitorContainer(player.Character) end
	if player:FindFirstChild("Backpack") then monitorContainer(player.Backpack) end
	player.CharacterAdded:Connect(function(char) monitorContainer(char) end)
end

-- Connect all players
Players.PlayerAdded:Connect(monitorPlayer)
for _, p in ipairs(Players:GetPlayers()) do
	monitorPlayer(p)
end
